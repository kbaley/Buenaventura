@page "/expense-analysis/{categoryId:guid}"
@using Buenaventura.Client.Components.DashboardCharts
@using ApexCharts
@inject IExpensesApi ExpensesApi
@inject ITransactionsApi TransactionsApi

<MudBreadcrumbs Items="_breadcrumbs" Class="mb-4"></MudBreadcrumbs>

<MudGrid>
    <!-- Spending Summary Cards -->
    <MudItem xs="12" md="6">
        <MudPaper Elevation="1" Class="pa-4">
            <MudText Typo="Typo.h6">Spending This Month</MudText>
            <MudText Typo="Typo.h4" Color="MudBlazor.Color.Primary">@thisMonthSpending.ToString("C0")</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" md="6">
        <MudPaper Elevation="1" Class="pa-4">
            <MudText Typo="Typo.h6">Spending Last Month</MudText>
            <MudText Typo="Typo.h4" Color="MudBlazor.Color.Secondary">@lastMonthSpending.ToString("C0")</MudText>
        </MudPaper>
    </MudItem>

    <!-- Spending Over Last 12 Months -->
    <MudItem xs="12">
        <LineChart
            IsLoading="isLoading"
            ChartData="@lastTwelveMonthsData"
            ComparisonData="@previousTwelveMonthsData"
            SeriesName="Current Period"
            ComparisonSeriesName="Previous Period"
            Title="Spending Over Last 12 Months"
            Height="350"
        />
    </MudItem>

    <!-- Comparison Chart -->
    <MudItem xs="12" md="6">
        <MudPaper Elevation="1" Class="pa-4" Height="400px">
            @if (isLoading)
            {
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="300px" />
            }
            else
            {
                <ApexChart TItem="ReportDataPoint" Title="30 Day Average Spending" Height="300" Options="comparisonChartOptions">
                    <ApexPointSeries TItem="ReportDataPoint"
                                     Items="comparisonData"
                                     Name="Average Spending"
                                     XValue="@(e => e.Label)"
                                     YValue="@(e => e.Value)"
                                     SeriesType="SeriesType.Bar" />
                </ApexChart>
            }
        </MudPaper>
    </MudItem>

    <!-- Spending by Vendor (Additional useful chart) -->
    <MudItem xs="12" md="6">
        <MudPaper Elevation="1" Class="pa-4" Height="400px">
            @if (isLoading)
            {
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="300px" />
            }
            else
            {
                <ApexChart TItem="ReportDataPoint" Title="Spending by Vendor" Height="300" Options="vendorChartOptions">
                    <ApexPointSeries TItem="ReportDataPoint"
                                     Items="vendorData"
                                     Name="Spending"
                                     XValue="@(e => e.Label)"
                                     YValue="@(e => e.Value)"
                                     SeriesType="SeriesType.Donut" />
                </ApexChart>
            }
        </MudPaper>
    </MudItem>

    <!-- Transaction List -->
    <MudItem xs="12">
        <MudPaper Elevation="1" Class="pa-4">
            <MudText Typo="Typo.h6" GutterBottom="true">Transactions</MudText>
            <MudTable ServerData="LoadTransactions" Dense="true" Hover="true" Bordered="true" Striped="true" RowsPerPage="10">
                <HeaderContent>
                    <MudTh>Date</MudTh>
                    <MudTh>Vendor</MudTh>
                    <MudTh>Description</MudTh>
                    <MudTh>Account</MudTh>
                    <MudTh Style="text-align:right">Amount</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Date">@context.TransactionDate.ToShortDateString()</MudTd>
                    <MudTd DataLabel="Vendor">@context.Vendor</MudTd>
                    <MudTd DataLabel="Description">@context.Description</MudTd>
                    <MudTd DataLabel="Account">@context.AccountName</MudTd>
                    <MudTd DataLabel="Amount" Style="text-align:right">@context.Amount.ToString("C2")</MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager />
                </PagerContent>
            </MudTable>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    [Parameter] public Guid CategoryId { get; set; }
    private CategoryModel category = new();
    private bool isLoading = true;
    private decimal thisMonthSpending;
    private decimal lastMonthSpending;
    private List<ReportDataPoint> lastTwelveMonthsData = [];
    private List<ReportDataPoint> previousTwelveMonthsData = [];
    private List<ReportDataPoint> comparisonData = [];
    private List<ReportDataPoint> vendorData = [];

    private readonly List<BreadcrumbItem> _breadcrumbs =
    [
        new("Dashboard", href: "/"),
        new("Expense Analysis", href: "/expense-analysis")
    ];

    private readonly ApexChartOptions<ReportDataPoint> comparisonChartOptions = Services.ChartOptions.GetDefaultOptions<ReportDataPoint>();
    private readonly ApexChartOptions<ReportDataPoint> vendorChartOptions = Services.ChartOptions.GetDefaultOptions<ReportDataPoint>();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        
        var data = await ExpensesApi.GetExpenseCategoryPageData(CategoryId);
        
        category = data.Category;
        _breadcrumbs.Add(new BreadcrumbItem(category.Name, href: null, disabled: true));
        thisMonthSpending = data.ThisMonthSpending;
        lastMonthSpending = data.LastMonthSpending;
        lastTwelveMonthsData = data.LastTwelveMonthsData;
        previousTwelveMonthsData = data.PreviousTwelveMonthsData;
        comparisonData = data.ComparisonData;
        vendorData = data.VendorData;

        isLoading = false;
    }

    private async Task<TableData<TransactionForDisplay>> LoadTransactions(TableState state, CancellationToken token)
    {
        var result = await TransactionsApi.GetTransactionsByCategory(CategoryId, state.Page, state.PageSize);
        return new TableData<TransactionForDisplay>
        {
            TotalItems = result.TotalCount,
            Items = result.Items
        };
    }
}