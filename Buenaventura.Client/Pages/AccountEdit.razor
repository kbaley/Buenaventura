@page "/account/edit/{accountId:guid}"
@page "/account/create"
@inject IAccountsApi accountsApi
@inject NavigationManager navigationManager
@inject AccountSyncService accountSyncService

@attribute [Authorize]

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">@PageTitle</MudText>
    <MudPaper Class="pa-4" Elevation="1">
        <MudForm @ref="form" @bind-IsValid="@success" @bind-Errors="@errors">
            <MudGrid>
                <MudItem xs="12">
                    <MudTextField Label="Name" @bind-Value="account.Name" Required="true"/>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField Label="Vendor" @bind-Value="account.Vendor"/>
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudSelect T="string" Label="Account Type" @bind-Value="account.AccountType">
                        @foreach (var accountType in accountTypes)
                        {
                            <MudSelectItem Value="@accountType">@accountType</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudSelect T="string" Label="Currency" @bind-Value="account.Currency">
                        @foreach (var currency in currencies)
                        {
                            <MudSelectItem Value="@currency">@currency</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="3" md="3">
                    <MudCheckBox T="bool" Label="Hidden" @bind-Value="account.IsHidden"/>
                </MudItem>
                <MudItem xs="9" md="9">
                    <MudCheckBox T="bool" Label="Exclude from transaction report" @bind-Value="account.ExcludeFromReports"/>
                </MudItem>
                @if (IsCreateMode)
                {
                    <MudItem xs="12" md="6">
                        <MudNumericField T="decimal"
                                         Label="Starting Balance"
                                         @bind-Value="account.StartingBalance"/>
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudDatePicker Label="Starting Date"
                                       @bind-Date="startDate"
                                       Required="true"/>
                    </MudItem>
                }
                <MudItem xs="12" md="12">

                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="SaveAccount"
                               Disabled="!success"
                               Class="mt-4">
                        <MudIcon Icon="@Icons.Material.Filled.Save" Class="me-2"/>
                        @(IsCreateMode ? "Create" : "Save")
                    </MudButton>

                    <MudButton Variant="Variant.Text"
                               Color="Color.Default"
                               OnClick="Cancel"
                               Class="mt-4">
                        Cancel
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudForm>
    </MudPaper>
</MudContainer>
@code {
    [Parameter] public Guid? AccountId { get; set; }
    private AccountWithBalance account = new();
    private readonly List<string> accountTypes = AccountType.GetAccountTypes().ToList();

    private readonly List<string> currencies = ["USD", "CAD"];
    private bool success;
    private string[] errors = [];
    private MudForm? form;
    private DateTime? startDate;
    private bool IsCreateMode => !AccountId.HasValue;
    private string PageTitle => IsCreateMode ? "Create Account" : "Edit Account";

    protected override async Task OnInitializedAsync()
    {
        if (IsCreateMode)
        {
            account = new AccountWithBalance
            {
                Currency = "USD",
                StartDate = DateTime.Today,
                DisplayOrder = (await accountsApi.GetAccounts()).Count()
            };
            startDate = account.StartDate;
        }
        else
        {
            var accountId = AccountId ?? Guid.Empty;
            account = await accountsApi.GetAccount(accountId);
            startDate = account.StartDate == default ? DateTime.Today : account.StartDate;
        }

        await base.OnInitializedAsync();
        
        // Use StateHasChanged and InvokeAsync to ensure the UI is updated
        // and then validate the form after the component has rendered
        await InvokeAsync(StateHasChanged);
        await Task.Delay(10); // Small delay to ensure the form is fully rendered
        form?.Validate();
    }

    private async Task SaveAccount()
    {
        if (!success) return;

        if (IsCreateMode)
        {
            var accountForPosting = new AccountForPosting
            {
                AccountId = account.AccountId,
                Name = account.Name,
                StartingBalance = account.StartingBalance,
                StartDate = startDate ?? DateTime.Today,
                Currency = account.Currency,
                Vendor = account.Vendor,
                AccountType = account.AccountType,
                MortgagePayment = account.MortgagePayment,
                MortgageType = account.MortgageType,
                IsHidden = account.IsHidden,
                ExcludeFromReports = account.ExcludeFromReports,
                DisplayOrder = account.DisplayOrder
            };

            await accountsApi.CreateAccount(accountForPosting);
        }
        else
        {
            await accountsApi.UpdateAccount(account);
        }

        await accountSyncService.RefreshAccounts();
        StateHasChanged();
        navigationManager.NavigateTo("/accounts");
    }
    
    private void Cancel()
    {
        navigationManager.NavigateTo("/accounts");
    }
}
